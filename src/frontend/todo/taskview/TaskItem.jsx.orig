import React from 'react';
<<<<<<< HEAD
import MapImage from '../dialog/MapImage';
=======
import moment from 'moment';
import LocationAddress from '../utils/LocationAddress';
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
import _ from 'underscore';
import { getReadableDate } from '../../utility/date'
import { completeItem, removeItem, postponeItem } from '../actions/tasks';

class TaskItem extends React.Component{
<<<<<<< HEAD
	constructor(){
		super();
=======
	constructor(props){
		super(props);
		this.state={
			isExpanded: 0
		}; // define variable 'state'.

		_.extend(this.state, props.task); // Init state.
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
	}
	
	complete(){
		dispatch(completeItem(this.props.task._id));
	}

	discard(){
		const { dispatch } = this.props;
		dispatch(removeItem(this.props.task._id));
	}

<<<<<<< HEAD
	postpone(){
		const { dispatch } = this.props;
		dispatch(postponeItem(this.props.task._id));	
=======
	onStartToggle() {
		var patchRequest;

		if (this.state.taskOnProcess == false) {
			var timestamp = Date.now();
			patchRequest = {
				timestampStart: timestamp,
				taskOnProcess: true
			};
		}
		else {
			patchRequest = {
				taskOnProcess: false
			};
		}
		this.props.onUpdate(this.state._id, patchRequest);
		this.setState(patchRequest);
	}

	onDiscard(){
		this.props.onDiscard(this.state._id);
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
	}

	onToggleLocationButton(locName){
		var locList = ['home', 'school', 'work', 'etc'];
		var locIndex = 0;
		for (let i in locList){
			if (locList[i] == locName){
				locIndex = i;
				break;
			}
		}
		// Flip bit on locIndex
		const { dispatch } = this.props;
		dispatch(updateRelatedLocation(relatedLocation ^ (1 << (locList.length-1-locIndex))));
	}

	onExpandToggle(){
		var newVal = this.state.isExpanded ^ 1;
		this.setState({
			isExpanded: newVal
		})
	}

	getLocButtonStates(relatedLocation){
		var locButtonState={
			home: "btn-default",
			school: "btn-default",
			work: "btn-default",
			etc: "btn-default"
		};

		if (relatedLocation % 2 == 1)
			locButtonState.etc = "btn-check";
		relatedLocation = Math.floor(relatedLocation / 2);

		if (relatedLocation % 2 == 1)
			locButtonState.work = "btn-check";
		relatedLocation = Math.floor(relatedLocation / 2);

		if (relatedLocation % 2 == 1)
			locButtonState.school = "btn-check";
		relatedLocation = Math.floor(relatedLocation / 2);

		if (relatedLocation % 2 == 1)
			locButtonState.home = "btn-check";
		relatedLocation = Math.floor(relatedLocation / 2);

		return locButtonState;
	}

<<<<<<< HEAD
	render() {
		var descStr = this.props.task.description || '';
=======
	getDetailView(){
		var descStr = this.state.description || '';
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
		var rawMarkup = marked(descStr.toString(), {sanitize: true});
		var startDate, completeDate;
		var locButtonState = this.getLocButtonStates(this.props.task.relatedLocation);

		var completeButtonState = "btn-default";
<<<<<<< HEAD
		if(this.props.task.timestampComplete != null){
=======
		var processButtonState = "btn-default";
		if(this.state.timestampStart != null){
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
			startDate = (
				<div className="taskStartedDate">
					시작일: {getReadableDate(this.props.task.timestampStart)}
				</div>
			);
		}

		if(this.props.task.timestampComplete != null){
			completeDate = (
				<div className="task-complete-date">
					완료일: {getReadableDate(this.props.task.timestampComplete)}
				</div>
			);
			completeButtonState = "btn-check";
		}

		if (this.state.taskOnProcess == true) {
			processButtonState = "btn-check";
		}

		return (
			<div className="panel panel-default">
<<<<<<< HEAD
				<div className="panel-heading">
					<h2 className="task-name">{this.props.task.name}</h2>
=======
				<div className="panel-heading" onClick={this.onExpandToggle.bind(this)}>
					<h2 className="task-name">{this.state.name}</h2>
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
				</div>
				<div className="panel-body">
					<div className="row">
						<div className="col-md-8">
							<div className="task-description">
								<span dangerouslySetInnerHTML={{__html: rawMarkup}} />
							</div>
							<div className="task-relatedLocation">
								작업 가능 장소 선택 :
								<div className="btn-group">
									<button className={"btn " + locButtonState.home} data-toggle="집" label="집" onClick={this.onToggleLocationButton.bind(this, 'home')}>
										<span className="glyphicon glyphicon-home"></span>
									</button>
									<button className={"btn " + locButtonState.school} data-toggle="학교" label="학교" onClick={this.onToggleLocationButton.bind(this, 'school')}>
										<span className="glyphicon glyphicon-book"></span>
									</button>
									<button className={"btn " + locButtonState.work} data-toggle="직장" label="직장" onClick={this.onToggleLocationButton.bind(this, 'work')}>
										<span className="glyphicon glyphicon-briefcase"></span>
									</button>
									<button className={"btn " + locButtonState.etc} data-toggle="기타" label="기타" onClick={this.onToggleLocationButton.bind(this, 'etc')}>
										<span className="glyphicon glyphicon-flash"></span>
									</button>
								</div>
							</div>
							<LocationAddress location={this.state.locationstampCreated} />
							<div className="task-startlocation">
<<<<<<< HEAD
								Created Location:
								{ this.props.task.locationstampCreated ? <MapImage location={this.props.task.locationstampCreated} /> : null }
								Complete Location:
								{ this.props.task.locationstampComplete ? <MapImage location={this.props.task.locationstampComplete} /> : null }
=======
								생성 시 위치:
								{ this.state.locationstampCreated ? <LocationAddress location={this.state.locationstampCreated} /> : null }
								완료 위치:
								{ this.state.locationstampComplete ? <LocationAddress location={this.state.locationstampComplete} /> : null }
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
							</div>
						</div>
						<div className="card-contents col-md-4">
							<div className="task-importance">
								중요도: {this.props.task.importance}
							</div>
							<div className="taskCreatedDate">
								생성일: {getReadableDate(this.props.task.timestampCreated)}
							</div>
							{startDate}
							<div className="task-duedate">
								마감일: {getReadableDate(this.props.task.timestampDuedate)}
							</div>
							{completeDate}
						</div>
					</div>
					<div>
						<div className="btn-group">
<<<<<<< HEAD
							<button className={"btn " + completeButtonState} onClick={this.complete.bind(this)}>
=======
							<button className={"btn " + processButtonState} onClick={this.onStartToggle.bind(this)}>
								<span className="glyphicon glyphicon-play"></span> 시작
							</button>
							<button className={"btn " + completeButtonState} onClick={this.onCompleteToggle.bind(this)}>
								<span className="glyphicon glyphicon-check"></span> 완료
							</button>
							<button className="btn btn-default" label="Remind me later" onClick={this.props.onPostpone}>
								<span className="glyphicon glyphicon-send"></span> 나중에 알림
							</button>
							<button className="btn btn-default" label="Discard this task" onClick={this.onDiscard.bind(this)}>
								<span className="glyphicon glyphicon-trash"></span> 할 일 제거
							</button>
						</div>
					</div>
				</div>
			</div>
		);
	}

	getSimpleView(){
		var descStr = this.state.description || '';
		var rawMarkup = marked(descStr.toString(), {sanitize: true});
		var startDate, completeDate;
		var locButtonState = this.getLocButtonStates(this.state.relatedLocation);

		var completeButtonState = "btn-default";
		var processButtonState = "btn-default";
		if(this.state.timestampStart != null){
			startDate = (
				<div className="taskStartedDate">
					시작일: {this.getReadableDate(this.state.timestampStart)}
				</div>
			);
		}

		if(this.state.timestampComplete != null){
			completeDate = (
				<div className="task-complete-date">
					완료일: {this.getReadableDate(this.state.timestampComplete)}
				</div>
			);
			completeButtonState = "btn-check";
		}

		if (this.state.taskOnProcess == true) {
			processButtonState = "btn-check";
		}

		return (
			<div className="panel panel-default">
				<div className="panel-heading" onClick={this.onExpandToggle.bind(this)}>
					<h2 className="task-name">{this.state.name}</h2>
				</div>
				<div className="panel-body">
					<div>
						<div className="btn-group">
							<button className={"btn " + processButtonState} onClick={this.onStartToggle.bind(this)}>
								<span className="glyphicon glyphicon-play"></span> 시작
							</button>
							<button className={"btn " + completeButtonState} onClick={this.onCompleteToggle.bind(this)}>
>>>>>>> 8e462bd4d1d36e828cda3dd60b06640dfbc10b6d
								<span className="glyphicon glyphicon-check"></span> 완료
							</button>
							<button className="btn btn-default" label="Remind me later" onClick={this.postpone.bind(this)}>
								<span className="glyphicon glyphicon-send"></span> 나중에 알림
							</button>
							<button className="btn btn-default" label="Discard this task" onClick={this.discard.bind(this)}>
								<span className="glyphicon glyphicon-trash"></span> 할 일 제거
							</button>
						</div>
					</div>
				</div>
			</div>
		);

	}

	render() {
		// console.log('In TaskItem render():');
		// console.log(this.state);
		var viewContent;
		if (this.state.isExpanded == 1){
			viewContent = this.getDetailView();
		}
		else{
			viewContent = this.getSimpleView();
		}
		return viewContent;

	}

};

export default TaskItem;
